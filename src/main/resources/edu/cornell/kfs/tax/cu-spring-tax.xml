<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:p="http://www.springframework.org/schema/p"
    xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
                           http://www.springframework.org/schema/tx
                           http://www.springframework.org/schema/tx/spring-tx-2.0.xsd
                           http://www.springframework.org/schema/aop
                           http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">

    <bean id="taxModuleConfiguration" parent="taxModuleConfiguration-parentBean" />

    <bean id="taxModuleConfiguration-parentBean" abstract="true" parent="taxModuleConfiguration-base-parentBean" />

    <bean id="taxModuleConfiguration-base-parentBean" abstract="true" class="org.kuali.kfs.sys.FinancialSystemModuleConfiguration">
        <property name="namespaceCode" value="KFS-TAX" />
        <property name="initializeDataDictionary" value="true" />
        <property name="packagePrefixes">
            <list>
                <value>edu.cornell.kfs.tax</value>
            </list>
        </property>
        <property name="dataDictionaryPackages">
            <list>
                <value>edu/cornell/kfs/tax/businessobject/datadictionary</value>
                <value>edu/cornell/kfs/tax/document/datadictionary</value>
            </list>
        </property>
        <property name="databaseRepositoryFilePaths">
            <list>
                <value>edu/cornell/kfs/tax/cu-ojb-tax.xml</value>
            </list>
        </property>
        <property name="jobNames">
            <list>
                <value>taxProcessingJob</value>
            </list>
        </property>
        <property name="batchFileDirectories">
              <list>
                <value>${reports.directory}/tax</value>
                <value>${staging.directory}/tax</value>
              </list>
        </property>
    </bean>

    <bean id="taxModuleService" parent="taxModuleService-parentBean" />

    <bean id="taxModuleService-parentBean" abstract="true" class="org.kuali.kfs.sys.service.impl.KfsModuleServiceImpl">
        <property name="moduleConfiguration" ref="taxModuleConfiguration" />
    </bean>



    <!-- Services -->

    <bean id="taxProcessingService" class="edu.cornell.kfs.tax.service.impl.TaxProcessingServiceImpl">
        <property name="taxOutputDefinitionFileType" ref="taxOutputDefinitionFileType" />
        <property name="taxDataDefinitionFileType" ref="taxDataDefinitionFileType" />
        <property name="taxProcessingDao" ref="taxProcessingDao" />
    </bean>

    <bean id="taxOutputDefinitionFileType" parent="taxOutputDefinitionFileType-parentBean" />
    <bean id="taxOutputDefinitionFileType-parentBean" abstract="true" class="edu.cornell.kfs.tax.batch.TaxOutputDefinitionFileType">
        <property name="directoryPath">
            <value>${staging.directory}/tax</value>
        </property>
        <property name="digestorRulesFileName">
            <value>edu/cornell/kfs/tax/batch/taxOutputDefinitionDigesterRules.xml</value>
        </property>
        <property name="schemaLocation">
            <value>${externalizable.static.content.url}/xsd/tax/taxOutputDefinition.xsd</value>
        </property>
    </bean>

    <bean id="taxDataDefinitionFileType" parent="taxDataDefinitionFileType-parentBean" />
    <bean id="taxDataDefinitionFileType-parentBean" abstract="true" class="edu.cornell.kfs.tax.batch.TaxDataDefinitionFileType">
        <property name="directoryPath">
            <value>${staging.directory}/tax</value>
        </property>
        <property name="digestorRulesFileName">
            <value>edu/cornell/kfs/tax/batch/taxDataDefinitionDigesterRules.xml</value>
        </property>
        <property name="schemaLocation">
            <value>${externalizable.static.content.url}/xsd/tax/taxDataDefinition.xsd</value>
        </property>
    </bean>

    <bean id="taxProcessingDao" class="edu.cornell.kfs.tax.dataaccess.impl.TaxProcessingDaoJdbc" parent="platformAwareDaoJdbc">
        <property name="reportsDirectory">
            <value>${reports.directory}/tax</value>
        </property>
    </bean>

    <bean id="taxTableMetadataService" class="edu.cornell.kfs.tax.dataaccess.impl.TaxTableMetadataServiceOjbImpl" />



    <!-- Batch Jobs -->

    <bean id="taxProcessingStep" class="edu.cornell.kfs.tax.batch.TaxProcessingStep" parent="step">
        <property name="taxProcessingService" ref="taxProcessingService" />
    </bean>

    <bean id="taxProcessingJob" parent="scheduledJobDescriptor">
        <property name="steps">
            <list>
                <ref bean="taxProcessingStep" />
            </list>
        </property>
    </bean>



    <!--
        File format for batch upload of transaction overrides via a modified raw transaction row file.
        NOTE: If the raw transaction row output formatting is updated, the start/end values on here will need to be updated accordingly.
     -->

    <bean id="bulkTransactionOverrideFileType" parent="FlatFileParser" class="edu.cornell.kfs.tax.batch.TransactionOverrideParser">
        <property name="flatFileSpecification">
            <bean parent="FixedWidthFlatFileSpecification">
                <property name="objectSpecifications">
                    <list>
                        <!-- This specification just reads the file header, and uses a transient BO for property-setting convenience. -->
                        <bean parent="FlatFilePrefixObjectSpecification" p:linePrefix="Transaction_Detail_ID"
                                p:businessObjectClass="edu.cornell.kfs.tax.businessobject.TransactionOverrideHeader">
                            <property name="parseProperties">
                                <list>
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="header" p:start="0" p:end="2854" />
                                </list>
                            </property>
                        </bean>
                        <!-- This specification reads the actual overrides. -->
                        <bean parent="FlatFilePrefixObjectSpecification" p:businessObjectClass="edu.cornell.kfs.tax.businessobject.TransactionOverride">
                            <!--
                                NOTE: This specification temporarily stores the 1099 and 1042S boxes in the "taxType" and "boxNumber"
                                properties, respectively. The properties will be set to the correct final values by the processing.
                                
                                We also insert the whole line into "objectId" for easy retrieval, in case errors are encountered and
                                we need to include it in an error file.
                             -->
                            <property name="parseProperties">
                                <list>
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="universityDate" p:start="2271" p:end="2281"
                                            p:formatterClass="org.kuali.kfs.sys.businessobject.format.BatchDateFormatter" p:dateFormat="yyyy-MM-dd" />
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="documentNumber"
                                            p:start="53" p:end="67" p:rightTrim="true" />
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="financialDocumentLineNumber"
                                            p:start="77" p:end="92" p:formatterClass="org.kuali.rice.core.web.format.IntegerFormatter" p:rightTrim="true" />
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="taxType"
                                            p:start="2779" p:end="2787" p:rightTrim="true" />
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="boxNumber"
                                            p:start="2808" p:end="2818" p:rightTrim="true" />
                                    <bean parent="FixedWidthFlatFilePropertySpecification" p:propertyName="objectId" p:start="0" p:end="2854" />
                                </list>
                            </property>
                        </bean>
                    </list>
                </property>
                <property name="defaultBusinessObjectClass" value="edu.cornell.kfs.tax.businessobject.TransactionOverride" />
            </bean>
        </property>
        <property name="directoryPath">
            <value>${staging.directory}/tax</value>
        </property>
        <property name="fileExtension">
            <value>txt</value>
        </property>
        <property name="fileNamePrefix" value="taxoverride" />
        <property name="fileTypeIdentifier" value="bulkTransactionOverrideFileType" />
        <property name="titleKey" value="message.batchUpload.title.transactionOverride" />
        <property name="processor" ref="transactionOverrideProcessor" />
    </bean>

    <bean id="transactionOverrideProcessor" class="edu.cornell.kfs.tax.batch.TransactionOverrideProcessor">
    </bean>

</beans>
